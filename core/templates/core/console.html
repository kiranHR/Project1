{% extends "accesscontrol/profile.html" %}
{% load i18n humanize staticfiles auth_tokens %}

{% block page_title %}
<title> Console - ikwen </title>
{% endblock %}
{% block head_style %}
    {{ block.super }}
    <link href="{% static 'ikwen/ajaxuploader/css/fileuploader.css' %}" media="screen" rel="stylesheet" type="text/css" />
    <link rel='stylesheet' href="{% static 'ikwen/swiper/css/swiper.min.css' %}" />
    <style type="text/css">
        #cover nav {background: #fff; height: 42px; width: 100%}
        #cover nav ul {margin: 0; padding: 0}
        #cover nav li {border-right: 1px solid #ddd; display: inline-block; height: 42px; 
            overflow: hidden; padding-top: 9px; text-align: center; width: 49.4%}
        #cover nav li:last-child {border-right: none}
        #cover nav li a {color: #587389}
        #cover nav li a:hover {text-decoration: none}
        #cover nav li.current a {color: #18bc9c; font-weight: 700}
        @media (min-width: 476px) {
            #cover nav li {width: 160px}
            #cover nav li:last-child {border-right: 1px solid #ddd}
        }
        @media (max-width: 767px) {
            #access-requests > .container-fluid {padding: 0}
            #access-requests .swiper-slide {width: 40%}
        }
        @media (min-width: 768px) {
            #access-requests .swiper-slide {max-width: 150px; width: 30%}
        }
    </style>
{% endblock %}

{% block head_js %}
    {{ block.super }}
    <script src="{% static 'ikwen/swiper/js/swiper.jquery.min.js' %}"></script>
{% endblock %}

{% block after_head %}
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-5027563976936898",
        enable_page_level_ads: true
      });
    </script>
{% endblock %}
{% block stage %}
    <div id="stage">
        <header id="cover" class="subtle-shade">
            <div id="banner">
                <div class="frame">
                    {% if member.photo and member.photo.name %}
                        <div class="photo" style="background-image: url({{ member.photo.small_url }})">
                            <div class="upload-image"></div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                                     aria-valuemax="100">
                                    <span class="sr-only"></span>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="photo" style="background-image: url({% static 'ikwen/img/login-avatar.jpg' %})">
                            <div class="upload-image"></div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                                     aria-valuemax="100">
                                    <span class="sr-only"></span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    <h2 class="text-has-shade name visible-xs">{{ member.full_name|truncatewords:"2" }}</h2>
                </div>
                <div class="upload-image hidden-xs"></div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                         aria-valuemax="100">
                        <span class="sr-only"></span>
                    </div>
                </div>
                <h2 class="text-has-shade name hidden-xs">{{ member.full_name }}</h2>
            </div>
        </header>
        {% for service, event_list in access_request_events.items %}
            <div id="access-requests">
                <div class="{{ service.project_name_slug }} card subtle-shade">
                    <h3>
                        {% if service.config.logo.name %}
                            <img src="{{ service.config.logo.url }}" width="30"/>
                        {% endif %}
                        <a href="{{ service.url }}" style="cursor: pointer">{{ service.project_name }}</a>
                    </h3>
                    <h4 style="margin-top: 0">
                        {% trans "Request to join" %}
                        {% if event_list|length > 4 and event_list.0.event_type.target_url_name %}
                            {% url event_list.0.event_type.target_url_name as target_url %}
                            <a class="more" href="{{ target_url|append_auth_tokens:request }}">
                                {% trans "See all" %} ({{ event_list|length }})
                            </a>
                        {% endif %}
                    </h4>
                    <div class="row AccessRequest">
                        <div class="row swiper-container" style="margin-top: 5px">
                            <div class="swiper-wrapper">
                                {% for event in event_list %} {{ event.render|safe }} {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        <div id="cards">
            <div class="row">
                <div class="tpl card subtle-shade">
                    <h3>
                        <img width="30" />
                        <a target="_blank" class="project-name" style="cursor: pointer"></a>
                        <time></time>
                    </h3>
                    <div>
                        <div class="content row">
                            <div class="loading">
                                <p class="dots">...</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% if event_list|length == 0 %}
                    <div class="col-xs-12">
                        <div class="card empty subtle-shade">
                            <div>
                                <h4>{% trans "No event" %}</h4>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if request.user_agent.is_mobile %}
                    {% include 'core/snippets/console_event_list_mobile.html' %}
                {% else %}
                    {% include 'core/snippets/console_event_list.html' %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    {{ block.super }}
    <script src="{% static 'ikwen/ajaxuploader/js/fileuploader.js' %}"></script>
    {% include 'core/snippets/banner_and_pp_uploader.html' %}
    <script>
        (function() {
            var accessRequestSwiper = new Swiper('#access-requests .swiper-container', {
                slidesPerView: 'auto',
                breakpoints: {
                    10000: {
                        nextButton: '.swiper-button-next',
                        prevButton: '.swiper-button-prev',
                        spaceBetween: 15
                    },
                    767: {
                        nextButton: '.swiper-button-next',
                        prevButton: '.swiper-button-prev'
                    }
                }
            });
            function loadCardContent(eventId) {
                var _$card = $('#' + eventId),
                    baseUrl = _$card.data('base-url');
                {% if request.META.HTTP_HOST != 'localhost' %}
                    if (baseUrl.substr(-9) != 'ikwen.com') baseUrl += '/ikwen';
                {% endif %}
                $.getJSON(baseUrl + '{% url 'ikwen:load_event_content' %}?callback=?', {event_id: eventId, member_id: '{{ user.id }}'}, function(res) {
                    if (!res.html) {
                        _$card.remove();
                        return
                    }
                    _$card.find('.content').html(res.html);
                    ikwen.appendAuthTokens('#' + eventId)
                });
                _$card.addClass('loaded');
            }
            var dataSourceEmpty = false,
                loadingCards = false;
            $(window).scroll(function() {
                if (dataSourceEmpty || loadingCards) return;
                var scrollTop = $(this).scrollTop();
                if ($(document).height() - $(this).height() - scrollTop <= $('footer').height()) {
                    loadingCards = true;
                    var start = $('div#cards .card').length,
                        $col1 = $('.events-col1'),
                        $col2 = $('.events-col2'),
                        col1Height = $col1.height(),
                        col2Height = $col2.height();
                    var colCycle = col1Height > col2Height ? [$col2, $col1] : [$col1, $col2];
                    $.getJSON('{% url 'ikwen:console' %}', {start: start, format: 'json'}, function(events) {
                        if (events.length == 0) {
                            dataSourceEmpty = true;
                            return;
                        }
                        for (var i=0; i<events.length; i++) {
                            var event = events[i],
                                $card = $('div#cards .card.tpl').clone().removeClass('tpl');
                            $card.attr('id', event.id);
                            $card.data('base-url', event.project_url);
                            $card.find('.project-name').text(event.project_name).attr('href', event.project_url);
                            $card.find('img').attr('src', event.project_logo_url);
                            $card.find('time').text(event.created_on);
                            if (event.min_height) $card.find('.loading').css({minHeight: event.min_height + 'px', lineHeight: event.min_height + 'px'});
                            colCycle[i%2].append($card);
                            loadCardContent(event.id);
                        }
                        loadingCards = false;
                    });
                    $(this).addClass('loaded');
                }
            });
            $('div#cards .card:not(.tpl, .empty, .loaded)').each(function() {
                var id = $(this).attr('id');
                loadCardContent(id);
            });
            $.getJSON('{% url 'ikwen:reset_notices_counter' %}', {target: '{{ request.GET.target }}'}, function(data) {})
        })()
    </script>
{% endblock %}
