{% extends "core/base_bs.html" %}
{% load i18n %}
{% load humanize %}
{% load staticfiles %}

{% block page_title %}
<title> {{ profile_name }} - ikwen </title>
{% endblock %}
{% block head_style %}
    {{ block.super }}
    <link href="{% static 'ikwen/css/console.css' %}" media="screen" rel="stylesheet" type="text/css" />
    <style>
        body {background: #f6f6f6}
        {% if member.cover_image and member.cover_image.name %}
            #cover {background-image: url({{ member.cover_image.url }})}
        {% else %}
            #cover {background-image: url({% static 'ikwen/img/default-cover.jpg' %})}
        {% endif %}
        {% if member.photo and member.photo.name %}
            #banner .frame .photo {background-image: url({{ member.photo.small_url }})}
        {% else %}
            #banner .frame .photo {background-image: url({% static 'ikwen/img/login-avatar.jpg' %})}
        {% endif %}
    </style>
{% endblock %}

{% block content %}
    <div id="content" class="container">
        {% block stage %}
            <div id="stage">
                <div class="container-fluid" id="cards">
                    {% for elt in access_requests %}
                    <section class="access-request subtle-shade">
                        <div class="logo">
                            {% if elt.rq.member.photo and elt.rq.member.photo.name %}
                                <a href="{% url 'ikwen:profile' elt.rq.member.id %}" class="photo" style="background-image: url({{ elt.rq.member.photo.small_url }})"></a>
                            {% else %}
                                <a href="{% url 'ikwen:profile' elt.rq.member.id %}" class="photo" style="background-image: url({% static 'ikwen/img/login-avatar.jpg' %})"></a>
                            {% endif %}
                            <h4>{{ elt.rq.service.project_name }}</h4>
                        </div>
                        <div class="details row">
                            <div class="about">
                                <div class="col-sm-8 col-md-8">
                                    <h3>{{ elt.rq.get_title }}</h3>
                                    <p>{{ elt.rq.get_description }}</p>
                                </div>
                                <div class="col-sm-4 col-md-4">
                                    <button id="allow-access" class="btn btn-success btn-sm btn-block" data-request-id="{{ elt.rq.id }}" data-access-type="{{ elt.rq.type }}">{% trans "Grant access" %}</button>
                                </div>
                            </div>
                            <div class="groups" style="display: none">
                                <div class="group-choice">
                                    <h3>{% trans "Grant access as:" %}</h3>
                                    {% for group in groups %}
                                        <div class="form-group">
                                            <div class="radio"> <label> <input type="radio" name="group" value="{{ group.id }}" /> {{ group.name }} </label> </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <p class="text-success" style="display: none">{% trans "Access successfully granted to collaborator." %}</p>
                                <button id="confirm-group" data-request-id="{{ elt.rq.id }}" class="btn btn-success btn-sm btn-block">{% trans "Confirm" %}</button>
                            </div>
                        </div>
                    </section>
                    {% endfor %}
                </div>
            </div>
        {% endblock %}
        <div id="ad-space-right">
            <div>
                <h4>{% trans "Sponsored Ads" %}</h4>
                <div id="ad"></div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    {{ block.super }}
    <script type="text/javascript">
        (function() {
            var COLLABORATION_REQUEST = 'CollaborationRequest';
            $('#allow-access').click(function() {
                var requestId = $(this).data('request-id'),
                    accessType = $(this).data('access-type'),
                    _$details = $(this).parents('.details');
                if (accessType == COLLABORATION_REQUEST) {
                    if (_$details.find('.groups').length == 1) {
                        var groupId = _$details.find('.groups input').val();
                        _$details.find('.group-choice').hide();
                        confirmCollaborationRequest(requestId, groupId, _$details);
                    } else {
                        _$details.find('.about').hide();
                        _$details.find('.groups').show();
                    }
                } else {

                }
            });
            $('#confirm-group').click(function() {
                var requestId = $(this).data('request-id'),
                    groupId = $('div#access-request .groups input[name=group]').val(),
                    _$details = $(this).parents('.details');
                confirmCollaborationRequest(requestId, groupId, _$details);
            });
            function confirmServiceRequest() {
                $.getJSON('{% url 'ikwen:grant_access_to_collaborator' %}')
            }
            function confirmCollaborationRequest(requestId, groupId, _$details) {
                $.getJSON('{% url 'ikwen:grant_access_to_collaborator' %}', {request_id: requestId, group_id: groupId}, function(data) {
                    if (data.success) {
                        _$details.find('.about, .groups button').hide();
                        _$details.find('.groups, .groups p.text-success').show();
                    }
                })
            }
        })()
    </script>
{% endblock %}
